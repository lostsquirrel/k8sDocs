---
title: 控制器
date: 2020-07-09
publishdate: 2020-07-09
weight: 120
---
在机器人技术和自动化领域，一个控制回路就是一个控制系统状态的无限循环。
以下为控制回路的一个示例: 房间内的温度控制器
当用户设定一个温度值时，就是告知温度控制器其期望状态。 当时房间内实际的问题则是当前状态。 温度控制器就会启动相应的动作(开启或关闭相应的设备)来让当前状态逐渐趋近于期望状态。

在 k8s 中，控制器就是监控集群状态的控制循环，在需要的时候执行变更或请求其它服务执行变更。每一个控制器都在尝试让当前状态向期望状态演进。

## 控制模式 {#control-pattern}

一个控制器至少会跟踪一个k8s 资源类型。 这些[对象](../../00-overview/03-working-with-objects/00-kubernetes-objects/)都有一个 `spec` 字段来定义它的期望状态。该资源所对应的控制器就负责让当前状态逐渐趋近于期望状态。控制器可以直接采取动作实现状态的变更，但在 k8s 中，通常是一个控制器会向 `api-server` 发送消息来达到这个目的。接下来可以会有实例。

### 通过 api-server 实现控制

Job 控制器就是 k8s 内置控制器的一员. 内置控制器就是通过与集群 api-server 来实现状态管理.
Job 这种 k8s 资源类型的工作模型是，运行一个或多个 Pod 来完成某个任务，完成后就停止。
(一旦完成[调度](../../09-scheduling-eviction/)， Pod对蟓就会成为 `kubelet` 期望状态的组成部署)

当 Job 控制器接收到一个新的任务，就需要按照任务的需求在集群中的某些节点上运行指定数量的 Pod 来完成相应的任务。 但 Job 控制器本身并不会运行任意 Pod 或容器。 而是向 api-server 发送 创建或删除 Pod 的请求。控制中心中的其它组件就会根据请求信息(有新的 Pod 需要调度并运行)，然后最终完成任务。

在用户创建一个新的 Job 后，此时的期望状态就是完成这个 Job。 Job 控制器让当前状态逐渐趋近于期望状态： 创建 Job 需要完成任务的 Pod，此时就离完成 Job 进了不步。

控制器也会更新那些对控制器进行配置的对象。 例如： 当一个 Job 对应的任务完成后， Job 控制器更新对应 Job 的对象状态为 `Finished`

(就像开时提到的温度控制器有点类似，温度的控制器关闭指示灯表示当前房间内的温度达到用户设置所期望的温度)

### 直接控制

与 Job 控制方式不同， 有些控制需要对集群外的部分组成资源进行变更。
例如，用户使用一个控制回路来保证集群中有足够的节点， 此时这个控制器就需要一些集群外的资源来实现对节点的配置管理。
控制器也是通过 api-server 来获取外部资源的期望状态，然后再直接与外部系统通信让其状态实现向期望状态的迁移。
(实际就有一个控制器可以实现集群节点的水平扩展， 见 [集群扩容](../../../3-tasks/01-administer-cluster/10-cluster-management/#cluster-autoscaling))

## 期望状态与当前状态

k8s 是一个云原生的系统，能够处理持续不断的变更请求。
集群可以在任何时候发变更， 控制回路会自动的修复出现的问题。 也就是从始至终集群可能都不会达到一个稳定的状态。
当控制器都在正常运行且能够过成有效的变更，全局状态是否稳定就无关紧要了
(这段意思表达得不是很顺畅)

## 设计

按照设计宗旨， k8s 使用很多控制器，每个控制器管理特定方面的集群状态。大多数情况下， 一个特定的控制回路(控制器)使用一种类型的资源作为期望状态，并通过管理多种类型的资源来实现期望状态。 例如：一个 Job 控制器跟踪 Job 对象(发现新发布的任务)和 Pod 对象(用来运行任务和监测任务是否完成，什么时候完成)。 在这种情况下，其它组件创建 Job， Job 控制器再创建 Pod。
使用多个简单的的控制器而不是一个内部关联的单体控制回路集合理有优势。 因为控制器可能挂掉，k8s 在设计上也是允许这种情况发生的。

{{< note >}}
一般可以有多个控制器创建或更新同一个类型的对象。 在这种情况下， k8s 控制器保证只关注与控制资源关联的资源。 例如： 同时使用  Deployment 和 Job， 两者都会创建 Pod， 但 Job 的控制器不能删除 Deployment 创建的 Pod， 因为控制器可以傅秀对象包含的信息(标签)来区分各自不同的 Pod。
{{< /note >}}

## 运行控制器的方式

k8s 自带了一系列内置的控制器，运行在 `kube-controller-manager` 中，这些内置的控制提供了重要的核心功能。
例如 Deployment 控制器和 Job 控制器就是由 k8s 本身(内置控制器)提供的控制器。 k8s 允许运行弹性的控制中心，所以当任意内置控制器挂掉后，其它节点的控制器能接替其上任。

也可以找到用于扩展k8s 功能，运行在控制中心外的控制器。 如果用户愿意也可以自己编写全新的控制器。这些控制器可以以Pod的方式运行， 也可以运行在 k8s 集群之外。 具体由控制器的功能决定。

## 引申阅读

这里介绍怎么编写自己的控制器, 见[这里](../../11-extend-kubernetes/00-extend-cluster/#extension-patterns)
